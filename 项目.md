#                     			商城项目											

## 基础环境搭建

### 前台管理



解压 mrshop-manage-web.rar到vscode工作空间

使用vscode 打开项目

### 后台管理

​	项目结构

```java
1  mingrui-shop-parent

​	             2 mingrui-shop-basics 

​								3	mingrui-shop-config-server

​								3	mingrui-shop-eureka-server 8761 

​								3	mingrui-shop-zuul-server 8088 --> 80

​								3	mingrui-shop-upload-server 8200

​								.........

​				2 mingrui-shop-commons

​								3   mingrui-shop-common-core

​								.........

​				2 mingrui-shop-services

​								3  mingrui-shop-service-categoty 8100 

​								3  mingrui-shop-service-brand 8200 

​								3  mingrui-shop-service-spec 8300

​								........

​				2 mingrui-shop-services-api

​								3  mingrui-shop-service-api-categoty 

​								3  mingrui-shop-service-api-brand 

​								3  mingrui-shop-service-api-spec

​								...........
```



#### 创建项目

##### 	创建 父工程

​		![](C:\Users\Die\Desktop\图片\shop\fu.PNG)

删除src目录

父工程不需要写任何代码 

pom.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.baidu</groupId>
    <artifactId>mingrui-shop-parent</artifactId>
    <version>1.0-SNAPSHOT</version>
        
    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <properties>
        <!--项目构建编码-->
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF8</project.reporting.outputEncoding>
        <!--声明JDK版本-->
        <java.version>1.8</java.version>
        <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
        <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
    </properties>
    <!--boot 版本-->
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.1.RELEASE</version>
        <!--始终从仓库中获取，不从本地路径获取-->
        <relativePath />
    </parent>
    <dependencies>
        <!-- 集成commons工具类 -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
        <!-- 集成lombok 框架 -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <!--junit测试-->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>
        <!-- SpringBoot整合eureka客户端 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <!--boot 测试模块-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    <!-- 项目依赖,子级模块可以继承依赖-->
    <dependencyManagement>
        <dependencies>
            <!--cloud 依赖-->
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${mr.spring.cloud.version}</version>
                <type>pom</type>
                <!--解决maven单继承的问题-->
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    <!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
    <repositories>
        <repository>
            <id>spring-milestones</id>
            <name>Spring Milestones</name>
            <url>https://repo.spring.io/libs-milestone</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </repository>
    </repositories>
</project>
```



##### 创建基础服务父工程

1.在mingrui-shop-parent 工程名上右键-->new-->module

2.项目名为: mingrui-shop-basics

3.删除src目录

4.pom.xml

只需要把打包方式设置为pom即可,暂时先不要引入其他依赖



```java
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
```



##### 创建公共(工具)工程

1.在mingrui-shop-parent 工程名上右键-->new-->module

2.项目名为: mingrui-shop-commoms

3.删除src目录

4.pom.xml

```Java
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
```



##### 创建服务实现工程

1. 在mingrui-shop-parent 工程名上右键-->new-->module 

2. 项目名为: mingrui-shop-service

3. 删除src目录

4. pom.xml

   ```java
   <!--父级项目不需要打包所有packging的类型为pom-->
   <packaging>pom</packaging>
   <dependencies>
       <!-- SpringBoot-整合Web组件 -->
       <dependency>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter-web</artifactId>
       </dependency>
       <!-- springcloud feign组件 -->
       <dependency>
           <groupId>org.springframework.cloud</groupId>
           <artifactId>spring-cloud-starter-openfeign</artifactId>
       </dependency>
   </dependencies>
   ```

   

##### 创建服务接口工程

1. 在mingrui-shop-parent 工程名上右键-->new-->modul

2. 项目名为: mingrui-shop-service-api

3. 删除src目录

4. pom.xml

   ```java
   <!--父级项目不需要打包所有packging的类型为pom-->
   <packaging>pom</packaging>
   <dependencies>
       <!-- SpringBoot-整合Web组件 -->
       <dependency>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter-web</artifactId>
       </dependency>
   </dependencies>
   ```

   

###### 创建eureka服务

1.在mingrui-shop-basics工程名上右键-->new-->module

​	**注意:在点击finish之前一定要确认一遍当前创建工程的父工程是mingrui-shop-basics,接下来的项目创建的时候也是一样的**..

![](C:\Users\Die\Desktop\图片\shop\eureka.PNG)



2.pom.xml

```java
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mingrui-shop-basics</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>mingrui-shop-basic-eureka-server</artifactId>
        
    <dependencies>
        <!--eureka 服务依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
    </dependencies>
        
</project>
```

3.  application.yml

```java
server:
	port: 8761
spring:
	application:
		name: eureka-server
eureka:
	client:
		# eureka服务url,值为map集合默认key为defaultZone
		service-url:
			defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
		# 当前服务是否同时注册
		register-with-eureka: false
		# 去注册中心获取其他服务的地址
		fetch-registry: false
	instance:
		hostname: localhost
		# 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
		lease-renewal-interval-in-seconds: 1
		# 定义服务失效的时间，单位：秒 默认90
		lease-expiration-duration-in-seconds: 2
	server:
		# 测试时关闭自我保护机制，保证不可用服务及时踢出
		enable-self-preservation: false

```

4.启动类

```java
package com.baidu.hxw;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class);
    }
}
```











### nginx反向代理

本地域名解析 浏览器会首先在本机的hosts文件中查找域名映射的IP地址，如果查找到就返回IP ，没找到则进行 域名服务器解析，一般本地解析都会失败，因为默认这个文件是空的。

​		 Windows下的hosts文件地址：C:/Windows/System32/drivers/etc/hosts 

​		 Linux下的hosts文件所在路径： /etc/hosts



解决域名解析问题 hosts文件加上

```
127.0.0.1 api.mrshop.com
127.0.0.1 manage.mrshop.com
```



安装nginx

使用 nginx可以通过命令行来启动，

操作命令：

```
 启动： start nginx.exe

 停止： nginx.exe -s stop 

重新加载： nginx.exe -s reload
```

反向代理配置

修改nginx/conf/nginx.conf文件

```js
worker_processes 1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  manage.mrshop.com;
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        location / {
            proxy_pass http://127.0.0.1:9001;
			proxy_connect_timeout 600;
			proxy_read_timeout 600;

        }
    }
	server {
		listen 80;
		server_name api.mrshop.com;
		proxy_set_header X-Forwarded-Host $host;
		proxy_set_header X-Forwarded-Server $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		location / {
			proxy_pass http://127.0.0.1:8088;
			proxy_connect_timeout 600;
			proxy_read_timeout 600;
		}
	}	
}

```



反向代理中间的流程

1.浏览器准备发起请求，访问http://mamage.mrshop.com，但需要进行域名解析

2.优先进行本地域名解析，因为我们修改了hosts，所以解析成功，得到地址:127.0.0.1

3.请求被发往解析得到的ip，并默认使用80端口号 http://127.0.0.1:80

本机nginx一直监听80端口，因此捕获这个请求

4.nginx中配置了反向代理规则，将manage.mrshop.com 代理到 127.0.0.1：9001，因此请求被转发

5.后台系统的 webpack server 监听的端口号是9001，得到请求并处理，完成后将响应返回给nginx

6.nginx将得到的结果返回给浏览器







## 商品分类管理



### 查询

#### 	前台

​	Category.vue

![](C:\Users\Die\Desktop\图片\shop\category.PNG)



<img src="C:\Users\Die\Desktop\图片\shop\category2.PNG" style="zoom:80%;" />



```vue
<template>
    <v-card>
        <v-flex xs12 sm10>
            <v-tree url="/category/list" :isEdit="isEdit" @handleAdd="handleAdd" @handleEdit="handleEdit"
                @handleDelete="handleDelete" @handleClick="handleClick" />
        </v-flex>
    </v-card>
</template>
<script>
    //import {treeData} from '../../mockDB'
    export default {
        name: "category",
        data() {
            return {
                isEdit: true
            }
        },
        methods: {
            handleAdd(node) {
                console.log("add .... ");
                console.log(node);
            },
            handleEdit(id, name) {
                console.log("edit... id: " + id + ", name: " + name)
            },
            handleDelete(id) {
                console.log("delete ... " + id)
            },
            handleClick(node) {
                console.log(node)
            }
        }
    };
</script>
<style scoped>
</style>
```



Tree.vue

getData方法重新制定resp回调

```vue
<template>
    <v-list class="pt-0 pb-0" dense>
        <TreeItem class="item" :model="model" v-for="(model, index) in db" :key="index" :url="url" :isEdit="isEdit"
            :nodes="nodes" @handleAdd="handleAdd" @handleEdit="handleEdit" @handleDelete="handleDelete"
            @handleClick="handleClick" />
    </v-list>
</template>
<script>
    import TreeItem from './TreeItem';
    export default {
        name: "vTree",
        props: {
            url: String,
            isEdit: {
                type: Boolean,
                default: false
            },
            treeData: {
                type: Array
            }
        },
        data() {
            return {
                db: [],
                nodes: {
                    opened: null,
                    selected: { isSelected: false }
                }
            }
        },
        components: {
            TreeItem
        },
        created() {
            if (this.treeData && this.treeData.length > 0) {
                this.db = this.treeData;
                return;
            }
            this.getData();
        },
        methods: {
            getData() {
                //加载一级菜单
                this.$http.get(this.url, { params: { pid: 0 } }).then(resp => {
                    console.log(resp)
                    this.db = resp.data.data;
                    this.db.forEach(n => n['path'] = [n.name])
                })
            },
            handleAdd(node) {
                this.$emit("handleAdd", this.copyNodeInfo(node));
            },
            handleEdit(id, name) {
                this.$emit("handleEdit", id, name)
            },
            handleDelete(id) {
                this.deleteById(id, this.db);
                this.$emit("handleDelete", id);
            },
            handleClick(node) {
                this.$emit("handleClick", this.copyNodeInfo(node))
            },
            // 根据id删除
            deleteById(id, arr) {
                let src = arr || this.db;
                for (let i in src) {
                    let d = src[i];
                    if (d.id === id) {
                        src.splice(i, 1)
                        return;
                    }
                    if (d.children && d.children.length > 0) {
                        this.deleteById(id, d.children)
                    }
                }
            },
            copyNodeInfo(node) {
                const o = {};
                for (let i in node) {
                    o[i] = node[i];
                }
                return o;
            }
        },
        watch: {}
    }
</script>
<style scoped>
    .item {
        cursor: pointer;
    }
</style>
```

TreeItem.vue

121行  ： 修改回调

```vue
<template>
    <div>
        <v-list-tile @click="toggle" class="level1 pt-0 pb-0 mt-0 mb-0" :class="
    {'selected':isSelected}">
            <v-list-tile-avatar>
                <v-icon v-if="model.isParent">{{open ? 'folder_open' : 'folder'}}</vicon>
                    <v-icon v-if="!model.isParent">insert_drive_file</v-icon>
            </v-list-tile-avatar>
            <v-list-tile-content>
                <v-list-tile-title v-show="!beginEdit">
                    <span>{{model.name}}</span>
                </v-list-tile-title>
                <input v-show="beginEdit" @click.stop="" :ref="model.id" vmodel="model.name" @blur="afterEdit"
                    @keydown.enter="afterEdit" />
            </v-list-tile-content>
            <v-list-tile-action v-if="isEdit">
                <v-btn icon @mouseover="c1='primary'" @mouseout="c1=''" :color="c1" @click.stop="addChild">
                    <i class="el-icon-plus" />
                </v-btn>
            </v-list-tile-action>
            <v-list-tile-action v-if="isEdit">
                <v-btn icon @mouseover="c2='success'" @mouseout="c2=''" :color="c2" @click.stop="editChild">
                    <i class="el-icon-edit" />
                </v-btn>
            </v-list-tile-action>
            <v-list-tile-action v-if="isEdit">
                <v-btn icon @mouseover="c3='error'" @mouseout="c3=''" :color="c3" @click.stop="deleteChild">
                    <i class="el-icon-delete" />
                </v-btn>
            </v-list-tile-action>
        </v-list-tile>
        <v-list v-if="isFolder" v-show="open" class="ml-4 pt-0 pb-0" dense transition="scale-transition">
            <tree-item class="item" v-for="(model, index) in model.children" :key="index" :model="model" :url="url"
                :isEdit="isEdit" :nodes="nodes" :parentState="open" @handleAdd="handleAdd" @handleEdit="handleEdit"
                @handleDelete="handleDelete" @handleClick="handleClick">
            </tree-item>
        </v-list>
    </div>
</template>
<script>
    import Vue from 'vue'
    export default {
        name: "tree-item",
        props: {
            model: Object,
            url: String,
            isEdit: {
                type: Boolean,
                default: false
            },
            nodes: Object,
            parentState: Boolean
        },
        created() {
        },
        data: function () {
            return {
                c1: '',
                c2: '',
                c3: '',
                isSelected: false,
                open: false,
                beginEdit: false
            }
        },
        watch: {
            parentState(val) {
                if (!val) {
                    this.open = val;
                }
            }
        },
        computed: {
            isFolder: function () {
                return this.model.children &&
                    this.model.children.length > 0
            }
        },
        methods: {
            toggle: function () {
                // 将其它被选中项取消选中
                this.nodes.selected.isSelected = false;
                // 当前项被选中
                this.isSelected = true;
                // 保存当前选中项
                this.nodes.selected = this
                // 客户自己的点击事件回调
                this.handleClick(this.model);
                // 判断是否为顶级节点，顶级节点需要记录和替换
                if (this.model.parentId == 0) {
                    // 判断打开节点是否是自己
                    if (this.nodes.opened && this != this.nodes.opened) {
                        // 不是，则关闭原来的节点
                        this.nodes.opened.open = false;
                    }
                    // 将自己记录为打开的节点
                    this.nodes.opened = this;
                }
                // 切换开闭状态
                this.open = !this.open;
                // 如果已经是叶子节点,或者自己是关闭的，或者自己已经有儿子了，结束
                if (!this.model.isParent || this.isFolder || !this.open) {
                    return;
                }
                // 展开后查询子节点
                //点击父节点信息回调
                this.$http.get(this.url, { params: { pid: this.model.id } })
                    .then(resp => {
                        Vue.set(this.model, 'children', resp.data.data);
                        // 封装当前节点的路径
                        this.model.children.forEach(n => {
                            n['path'] = [];
                            this.model.path.forEach(p => n['path'].push(p));
                            n['path'].push(n.name);
                        });
                    }).catch(e => {
                        console.log(e);
                    });
            },
            addChild: function () {
                let child = {
                    id: 0,
                    name: '新的节点',
                    parentId: this.model.id,
                    isParent: false,
                    sort: this.model.children ? this.model.children.length + 1 : 1
                }
                if (!this.model.isParent) {
                    Vue.set(this.model, 'children', [child]);
                    this.model.isParent = true;
                    this.open = true;
                    this.handleAdd(child);
                } else {
                    if (!this.isFolder) {
                        this.$http.get(this.url, { params: { pid: this.model.id } }).then(resp
                            => {
                            Vue.set(this.model, 'children', resp.data.data);
                            this.model.children.push(child);
                            this.open = true;
                            this.handleAdd(child);
                        });
                    } else {
                        this.model.children.push(child);
                        this.open = true;
                        this.handleAdd(child);
                    }
                }
            },
            deleteChild: function () {
                this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
                    confirmButtonText: '确定删除',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.handleDelete(this.model.id);
                }).catch(() => {
                    this.$message.info('已取消删除');
                })
            },
            editChild() {
                this.beginEdit = true;
                this.$nextTick(() => this.$refs[this.model.id].focus());
            },
            afterEdit() {
                if (this.model.beginEdit) {
                    this.beginEdit = false;
                    this.handleEdit(this.model.id, this.model.name);
                }
            },
            handleAdd(node) {
                this.$emit("handleAdd", node);
            },
            handleDelete(id) {
                this.$emit("handleDelete", id);
            },
            handleEdit(id, name) {
                this.$emit("handleEdit", id, name)
            },
            handleClick(node) {
                this.$emit("handleClick", node);
            }
        }
    }
</script>
<style scoped>
    .level1 {
        height: 40px;
    }

    .selected {
        background-color: rgba(105, 184, 249, 0.75);
    }
</style>
```

依次启动eureka-server,xxx-service,zuul-server,vue项目 保证自己的hosts,nginx没有问题

浏览器搜索manage.mrshop.com

#### 	后台

##### 	1.新建 mingrui-shop-common-core工程

​		在mingrui-shop--commons 项目下新建mingrui-shop-common-core项目

​	2. pom.xml

```java
<dependencies>

        <!--处理json与各种数据类型或文档类型的转换-->
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>2.8.5</version>
        </dependency>
        <!--json对象序列化和反序列化的支持-->
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-core-lgpl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-mapper-lgpl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <!--java对象和json对象之间的转换-->
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-core-asl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <dependency>
            <groupId>org.codehaus.jackson</groupId>
            <artifactId>jackson-mapper-asl</artifactId>
            <version>1.9.13</version>
        </dependency>
        <!--alibaba的json处理工具-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.62</version>
        </dependency>
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.11.2</version>
        </dependency>

    </dependencies>
```



新建包com.baidu.shop.utils

JSONUtil

```java
package com.baidu.shop.utils;
import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;


public class JSONUtil {
    private static Gson gson = null;
    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }
    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }
    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }
    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }
    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }
    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }
    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }
    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }
    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }
    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }
    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }
    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }
    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }
    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }
    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }

}

```



新建包 com.baidu.shop.status

HTTPStatus

```java
public class HTTPStatus {
	public static final int OK = 200;//成功
	public static final int ERROR = 500;//失败
}
```



新建包 com.baidu.shop.base

###### 泛型的高级使用

https://note.youdao.com/ynoteshare1/index.html?id=a83103814321b63e12f932c5552c197d&type=note

###### lombok:

https://www.jianshu.com/p/2543c71a8e45

 Result

```java
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
public class Result<T> {

    private Integer code;//返回码

    private String message;//返回消息

    private T data;//返回数据

    public Result(Integer code , String message , Object data){
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }
}

```

BaseApiService

```java 
package com.baidu.shop.base;

import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.JSONUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

@Data
@Component
@Slf4j
public class BaseApiService<T> {

    public Result<T> setResultError(Integer code,String message){
        return setResult(code,message,null);
    }

    //返回错误 可以传message
    public Result<T> setResultError(String message){
        return setResult(HTTPStatus.ERROR,message,null);
    }

    //返回成功 可以传data值
    public Result<T> setResultSuccess(T data){
        return setResult(HTTPStatus.OK , HTTPStatus.OK + "" , data);
    }

    //返回成功 没有传data值
    public Result<T> setResultSuccess(){
        return setResult(HTTPStatus.OK , HTTPStatus.OK + "" , null);
    }

    //返回成功 没有data值
    public Result<T> setResultSuccess(String message){
        return setResult(HTTPStatus.OK , message , null);
    }

    //通用封装
    public Result<T> setResult(Integer code,String message,T data){
        log.info(String.format("{code : %s , message : %s , data : %s }",code,message, JSONUtil.toJsonString(data)));
        return new Result<T>(code,message,data);
    }
}

```



#####  service-api工程

mingrui-shop-service-api/pom.xml

```java
<!--Entity 中的@Table 和@Id需要次注解-->
        <dependency>
            <groupId>javax.persistence</groupId>
            <artifactId>persistence-api</artifactId>
            <version>1.0.2</version>
        </dependency>
        <!--2.3版本之后web删除了验证插件-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <!--引入common工程代码-->
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-common-core</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
```



##### mingrui-shopservice-api-xxx

在mingrui-shop-service-api项目下新建mingrui-shopservice-api-xxx项目

pom.xml

```java
<dependencies>

        <!--帮助开发人员快速生成API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger2</artifactId>
            <version>2.9.2</version>
        </dependency>
        <!--提供可视化的API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger-ui</artifactId>
            <version>2.9.2</version>
        </dependency>

    </dependencies>
```

com.baidu.shop.entity

```java
package com.baidu.shop.entity;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {

    @Id
    @ApiModelProperty(value = "分类主键",example = "1")
    private Integer id;
    
    @ApiModelProperty(value = "分类名称")
    private String name;
    
    @ApiModelProperty(value = "父级分类",example = "1")
    private Integer parentId;
    
    @ApiModelProperty(value = "是否是父级节点",example = "1")
    private Integer isParent;
    
    @ApiModelProperty(value = "排序",example = "1")
    private Integer sort;
}

```



swagger2的配置

新建com.baidu.shop.config.MrSwagger2Config

```java
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;


@Configuration
@EnableSwagger2
public class MrSwagger2Config {

    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }
    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new
                        Contact("shenyaqi","baidu.com","shenyaqiii@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }

}

```



定义商品分类接口

新建com.baidu.shop.service包新建CategoryService接口

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.List;

@Api(tags = "商品分类接口")
public interface CategoryService {

    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);
}

```



##### service工程

mingrui-shop-service/pom.xml

```java
<dependencies>

        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        
        <!--mysql数据库连接-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope><!--项目运行阶段使用-->
        </dependency>
        
        <!--通用mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
            <version>2.1.5</version>
        </dependency>
        
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
        
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-service-api-xxx</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        
    </dependencies>
```



##### mingrui-shop-service-xxx工程

 在mingrui-shop-service工程下新建mingrui-shop-service-xxx工程

application.yml

```yml
server:
  port: 8100

spring:
  application:
    name: xxx-server
  # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://127.0.0.1:3306/2005?useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000

# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL

#日志设置
logging:
  level:
    # 打印与我们程序相关的日志信息
    com.baidu.shop: debug

# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

新建包com.baidu

新建启动类

```java
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")
public class RunXXXApplication {

    public static void main(String[] args) {
        SpringApplication.run(RunXXXApplication.class);
    }
}

```

在com.baidu下新建包shop.mapper

创建mapper

```java
import com.baidu.shop.entity.CategoryEntity;
import tk.mybatis.mapper.common.Mapper;

public interface CategoryMapper extends Mapper<CategoryEntity> {
}

```



在com.baidu下新建包shop.service.impl

新建实现类

```java
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.service.CategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import java.util.List;

@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {

    @Autowired
    private CategoryMapper categoryMapper;
    
	@Override
	public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {
	
		CategoryEntity categoryEntity = new CategoryEntity();
		categoryEntity.setParentId(pid);
		
		List<CategoryEntity> list = categoryMapper.select(categoryEntity);
		
		return this.setResultSuccess(list);
	}
}

```



##### 网关服务

 在mingrui-shop-basic项目下新建mingrui-shop-basiczuul-server

pom.xml

```java
<dependencies>

    <!-- zuul -->
    <dependency>
    	<groupId>org.springframework.cloud</groupId>
    	<artifactId>spring-cloud-starter-netflix-zuul</artifactId>
    </dependency>
    
</dependencies>
```



application.yml

```yml
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
      # 启用重试
  retryable: true
 

#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```



新建包com.baidu

新建启动类

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@SpringBootApplication
@EnableZuulProxy
@EnableEurekaClient
public class RunZuulServerApplication {

    public static void main(String[] args) {
    	SpringApplication.run(RunZuulServerApplication.class);
    }
}
```



在com.baidu下新建global.GlobalCorsConfig

```java
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;


@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
        //3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}

```







### 删除

#### 前台

1.前台点击删除按钮  获取该数据的ID

2.前台把获取的ID传递给后台



Category.vue

```vue
 handleDelete(id) {
        this.$http.delete('/category/delete?id='+id).then(resp=>{
          if(resp.data.code != 200){
            this.$message.error('删除失败' + resp.data.message);
            return ;
          }
          this.delkey =new Date().getTime();
          this.$message.success('删除成功')
        }).catch(error => console.log(error))
      },
```



TreeItem.vue

```vue
deleteChild: function () {
        if(this.model.isParent == 1 ){
          //提示信息
          this.$message.warning('当前节点为父节点，不能被删除');
          return ;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
```



给v-tree组件绑定一个key的属性 默认值为0 

```vue
<v-tree url="category/list" :key="delkey" />

data() {
      return {
        delkey:0
      }
    },
```



删除功能完成后 给delkey重新赋一个值  用来实现组件刷新

```vue
 this.delkey =new Date().getTime();
```





#### 后台

1.接口添加删除方法

mingrui-shop-service-api-xxx 项目中的com.baidu.shop.service包下CategoryService接口中添加

```java
@ApiOperation(value = "通过ID删除商品分类")
    @DeleteMapping(value = "category/delete")
	//value中的路径要和Category.vue的handleDelete中的路径一致
    Result<JsonObject> deleteCategoryById(Integer id);
```



2.实现接口中的方法

mingrui-shop-service-xxx 项目中的com.baidu.shop.service.impl包下的CategoryServiceImpl类中

实现接口

```java
	@Transactional //以后增删改都得加这个注解
    @Override
    public Result<JsonObject> deleteCategoryById(Integer id) {

        //校验ID是否合法
        //ObjectUtils为自己封装的工具类
        if(ObjectUtils.isNull(id) || id <= 0) return this.setResultError("id不合法");

        //查询前台传过来得ID得数据
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

        //如果为空 说明数据库没有该数据  直接 return 并提示数据不存在 （return之后 后面的代码将不会再去执行）
        if(ObjectUtils.isNull(categoryEntity)) return this.setResultError("数据不存在");

        //判断该节点是否为父节点 
        //(数据库字段 parentID 如果为 1 的话 就是父节点  为0的话就是子节点 )
        //为父节点的话就 return 并提示 为父节点 不能被删除  不是父节点得话 继续向下执行
        //不可以直接删除父节点 因为父节点有好多字节点 容易丢失数据 不太安全
        if(categoryEntity.getParentId() ==1) return this.setResultError("当前为父节点 不能被删除");

        //tkmapper推荐这种条件查询
        //拼接sql语句 
        //new一个Example对象 并且把实体类放进去
        //andEqualTo("key" , value)
        //根据实体类的字段然后生成语句  
        //where parent_id = categoryEntity.getParentId()
        //前两句执行完 然后把example对象放进selectByExample参数里 
        //也就是categoryMapper.selectByExample(example)
        // 最终sql语句后面会拼接 where parent_id = categoryEntity.getParentId()
        //！！！！！！
        //通过当前节点的父节点id  也就是当前节点的parentId则是他父节点的Id
        //然后通过父节点的ID 来查询当前节点(将要删除的节点)的父节点下是否还有其他子节点
        Example example = new Example(CategoryEntity.class);
        example.createCriteria().andEqualTo("parentId" , categoryEntity.getParentId());
        List<CategoryEntity> categoryList = categoryMapper.selectByExample(example);
		
        //判断categoryList的长度是否小于等于1
        //如果大于1的话说明该父节点还有别的子节点 则可以直接删除
        //如果小于或者等于1的话 就需要将该父节点的状态改为叶子节点状态
        //叶子节点就是 最后一个节点 表示当前节点下没有任何子节点
        //IsParent的值只有1和0  1则代表是父节点 0则代表是叶子节点
        //也就是 IsParent 的值 修改为0
        if(categoryList.size() <= 1){
            CategoryEntity updateCategoryEntity = new CategoryEntity();
            updateCategoryEntity.setIsParent(0);
            updateCategoryEntity.setId(categoryEntity.getParentId());

            categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);
        }

        //通过ID删除节点
        categoryMapper.deleteByPrimaryKey(id);
		
        //删除成功，返回
        return this.setResultSuccess();
    }
```



自己封装的ObjectUtils工具类

```java
public class ObjectUtils {

    public static Boolean isNull(Object obj){
        return obj == null;
    }

    public static Boolean isNotNull(Object obj){
        return obj != null;
    }
}

```





###### 删除流程图

<img src="D:\liuyue\商品管理删除流程图.png" style="zoom:80%;" />







### 修改

#### 	前台

Category.vue页面		

浏览器收集数据 然后用Axios发送给后台

```vue
handleEdit(id, name) {
        console.log("edit... id: " + id + ", name: " + name)
        //axios提交
        this.$http.put('/category/update',{id:id,name:name})
        .then(resp => {
          if(resp.data.code != 200){
            this.$message.error('修改错误' + resp.data.message);
            return ;
          }
          this.$message.success('修改成功');
          this.key = new Date().getTime();
        }).catch(error => console.log(error))
      },
```



###### 

TreeItem.vue

```vue
afterEdit() {
        if (this.model.beginEdit) { //需要把 this.model.beginEdit 修改为 this.beginEdit
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
```



#### 	后台

接口添加修改方法

​     @RequestBody 接收前台传递过来的参数(参数必须得是string类型的字符串[json])

​	json格式的字符串 "{}" 

​	json{}

```java
@ApiOperation(value = "修改商品分类")
    @PutMapping(value = "category/update")
    Result<JsonObject> updateCategory(@RequestBody CategoryEntity categoryEntity);
```



实现接口中的方法

```java
@Transactional
    @Override
    public Result<JsonObject> updateCategory(CategoryEntity categoryEntity) {

        categoryMapper.updateByPrimaryKeySelective(categoryEntity);

        return this.setResultSuccess();
    }
```



### 新增

#### 前台

Category.vue

```vue
handleAdd(node) {
        node.isParent = node.isParent?1:0;
        //删除id属性
        delete node.id
        //新增数据
        this.$http.post('/category/save',node).then((resp)=>{
          this.$message.success("新增成功");
          this.delKey = new Date().getTime();
        }).catch((err)=>{
          console.log(err);
        })
        console.log(node);
      },
```



#### 后台

common-core工程新建包com.baidu.shop.validate.group

 包下新建操作类MingruiOperation

```java
public class MingruiOperation {
    public interface Add{}
    public interface Update{}
    public interface Search{}
}

```

mingrui-shop-service-api-xxx

修改CategoryEntity

```java
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotNull;

@ApiModel(value = "分类实体类")
@Data
@Table(name = "tb_category")
public class CategoryEntity {
    @Id
    @ApiModelProperty(value = "类目id",example = "1")
    @NotNull(message = "类目id不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "类目名称")
    @NotNull(message = "类目名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "父类目id,顶级类目填0",example = "1")
    @NotNull(message = "父类目id不能为空",groups = {MingruiOperation.Add.class})
    private Integer parentId;

    @ApiModelProperty(value = "是否为父节点，0为否，1为是",example = "1")
    @NotNull(message = "是否为父节点不能为空",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value = "排序指数，越小越靠前",example = "1")
    @NotNull(message = "排序指数不能为空",groups = {MingruiOperation.Add.class})
    private Integer sort;
}

```

service

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@Api(tags = "商品分类接口")
public interface CategoryService {
    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

    @ApiOperation(value = "通过ID删除商品分类")
    @DeleteMapping(value = "category/delete")
    Result<JsonObject> deleteCategoryById(Integer id);

    @ApiOperation(value = "修改商品分类")
    @PutMapping(value = "category/update")
    Result<JsonObject> updateCategory(@Validated({MingruiOperation.Update.class}) @RequestBody CategoryEntity categoryEntity);
}

```







mingrui-shop-service-api-xxx

```java
@ApiOperation(value = "新增商品分类")
@PostMapping(value = "category/save")
Result<JsonObject> saveCategory(@Validated({MingruiOperation.Add.class}) @RequestBody CategoryEntity categoryEntity);
```

mingrui-shop-service-xxx

```java
@Transactional
@Override
public Result<JsonObject> saveCategory(CategoryEntity categoryEntity) {
		//根据前台传回来的数据 进行新增
    	
    	//new 一个实体类 
    	//根据前台传过来的数据的ParentId 获得他父节点的ID
		//获得他父节点的ID赋进去实例里 还有IsParent 赋值为1
        CategoryEntity saveCategoryEntity = new CategoryEntity();
        saveCategoryEntity.setId(categoryEntity.getParentId());
        saveCategoryEntity.setIsParent(1);
		
    	//把父节点的IsParent属性修改为1 (声明前台传过来的ID的父节点为父节点)
        categoryMapper.updateByPrimaryKeySelective(saveCategoryEntity);
		
    	//新增
        categoryMapper.insertSelective(categoryEntity);
		
    	//返回成功
        return this.setResultSuccess();
}
```



## 商品分类管理不完美的地方

#### 全局异常处理

common-core

pom.xml

```
<!-- SpringBoot-整合Web组件 -->
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-web</artifactId>
</dependency>
```

HTTPStatus

```
public static final int PARAMS_VALIDATE_ERROR = 5002;//参数校验失败
```

 新建包com.baidu.shop.global

新建全局异常处理类GlobalException

```java
package com.baidu.shop.global;
import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.google.gson.JsonObject;
import lombok.extern.slf4j.Slf4j;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.*;
import java.util.stream.Collector;
import java.util.stream.Collectors;


@RestControllerAdvice
@Slf4j
public class GlobalException {
    @ExceptionHandler(value = RuntimeException.class)
    public Result<JSONObject> testException(RuntimeException e){

        log.error("code : {} , message : {}",HTTPStatus.ERROR,e.getMessage());

        return new Result<JSONObject>(HTTPStatus.ERROR,e.getMessage(),null);
    }

    @ExceptionHandler(value= MethodArgumentNotValidException.class)
    public Map<String,Object> methodArgumentNotValidHandler(MethodArgumentNotValidException exception) throws Exception{
        // == ===区别???
        HashMap<String, Object> map = new HashMap<>();
        map.put("code",HTTPStatus.PARAMS_VALIDATE_ERROR);

        /*String message = "";
        //按需重新封装需要返回的错误信息
        for (FieldError error : exception.getBindingResult().getFieldErrors()) {
            message += "Field --> " + error.getField() + " : " + error.getDefaultMessage() + ",";
            log.error("Field --> " + error.getField() + " : " + error.getDefaultMessage());
        }
        map.put("massage",message.substring(0,message.lastIndexOf(",")));
        */

        List<String> msgList = new ArrayList<>();

        /*for (FieldError error : exception.getBindingResult().getFieldErrors()) {
            msgList.add("Field --> " + error.getField() + " : " + error.getDefaultMessage());
            log.error("Field --> " + error.getField() + " : " + error.getDefaultMessage());
        }*/
        exception.getBindingResult().getFieldErrors().stream().forEach(error -> {
            msgList.add("Field --> " + error.getField() + " : " + error.getDefaultMessage());
            log.error("Field --> " + error.getField() + " : " + error.getDefaultMessage());
        });

        //ArrayList 是线程不安全的 -->
        //hadoop --> HDFS(存储数据\文件) mapreduce(计算)
        //reverse   //gc --> gc垃圾回收器 ps + po
        String message = msgList.parallelStream().collect(Collectors.joining(","));

        map.put("massage",message);
        return map;
    }

}

```







## 品牌管理

### 查询

####  前台

官网地址: 表格:https://v15.vuetifyjs.com/zh-Hans/components/data-tables 

输入框:https://v15.vuetifyjs.com/zh-Hans/components/snackbars 

按钮:https://v15.vuetifyjs.com/zh-Hans/components/buttons

在item包下新建MrBrand.vue

```vue
<template>
  <v-card>
    <v-card-title>
      <v-btn @click="addBrand" color="primary">新增品牌</v-btn>
      <v-spacer/>
      <v-text-field
        append-icon="search"
        label="搜索"
        single-line
        hide-details
        v-model="search"
      />
    </v-card-title>
    <v-divider/>
    <v-data-table
      :headers="headers"
      :items="items"
      :pagination.sync="pagination"
      :total-items="totalItems"
      :loading="loading"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center"><img v-if="!!props.item.image" width="102" height="36" :src="props.item.image"/></td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="justify-center layout px-0">
          <v-btn icon @click="editBrand(props.item)">
            <i class="el-icon-edit"/>
          </v-btn>
          <v-btn icon @click="deleteBrand(props.item)">
            <i class="el-icon-delete"/>
          </v-btn>
        </td>
      </template>
      <template slot="expand" slot-scope="props">
        <v-card flat>
          <v-card-text>Peek-a-boo!</v-card-text>
        </v-card>
      </template>
      <template slot="no-data">
        <v-alert :value="true" color="error" icon="warning">
          对不起，没有查询到任何数据 :(
        </v-alert>
      </template>
      <template slot="pageText" slot-scope="props">
        共{{props.itemsLength}}条,当前:{{ props.pageStart }} - {{ props.pageStop }}
      </template>
    </v-data-table>

    <v-dialog v-model="show" max-width="600" scrollable v-if="show">
      <v-card>
        <v-toolbar dark dense color="primary">
          <v-toolbar-title>{{isEdit ? '修改品牌' : '新增品牌'}}</v-toolbar-title>
          <v-spacer/>
          <v-btn icon @click="show = false">
            <v-icon>close</v-icon>
          </v-btn>
        </v-toolbar>
        <v-card-text class="px-5 py-2">
          <!-- 表单 -->
          <brand-form :oldBrand="brand" :isEdit="isEdit" @close="show = false" :reload="getDataFromApi"/>
        </v-card-text>
      </v-card>
    </v-dialog>
  </v-card>

</template>

<script>
  import BrandForm from './BrandForm'
  import {brandData} from '../../mockDB'

  export default {
    name: "brand",
    components: {
      BrandForm
    },
    data() {
      return {
        search: '',// 过滤字段
        totalItems: 0,// 总条数
        items: [],// 表格数据
        loading: true,
        pagination: {},// 分页信息
        headers: [// 表头
          {text: 'id', align: 'center', value: 'id'},
          {text: '名称', align: 'center', sortable: false, value: 'name'},
          {text: 'LOGO', align: 'center', sortable: false, value: 'image'},
          {text: '首字母', align: 'center', value: 'letter', sortable: true,},
          {text: '操作', align: 'center', value: 'id', sortable: false}
        ],
        show: false,// 是否弹出窗口
        brand: {}, // 品牌信息
        isEdit: false // 判断是编辑还是新增
      }
    },
    watch: {
      pagination: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      },
      search: {
        handler() {
          this.getDataFromApi();
        }
      },
      show(val, oldVal) {
        // 表单关闭后重新加载数据
        if (oldVal) {
          this.getDataFromApi();
        }
      }
    },
    mounted() {
      this.getDataFromApi();
    },
    methods: {
      addBrand() {
        this.brand = {};
        this.isEdit = false;
        this.show = true;
      },
      editBrand(item) {
        this.brand = item;
        this.isEdit = true;
        this.show = true;
        // 查询商品分类信息，进行回显
        this.$http.get("/item/category/bid/" + item.id)
          .then(resp => {
            this.brand.categories = resp.data;
          })

      },
      deleteBrand(item) {
        this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
          // 发起删除请求
          this.$http.delete("/item/brand?id=" + item.id,)
            .then(() => {
              // 删除成功，重新加载数据
              this.$message.success("删除成功！");
              this.getDataFromApi();
            })
        }).catch(() => {
          this.$message.info("删除已取消！");
        });

      },
      getDataFromApi() {
        this.loading = true;
        // 200ms后返回假数据
        window.setTimeout(() => {
          this.items = brandData.slice(0,4);
          this.totalItems = 100
          this.loading = false;
        }, 200)
      }
    }
  }
</script>

<style scoped>

</style>
```



 index.js line : 27

```
 route("/item/brand",'/item/MrBrand',"MrBrand"),
```





#### 后台

在common-core 中的pom.xml添加依赖

```xml
    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>

```

在base包下新建BaseDTO

```java
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName BaseBTO
 * @Description: TODO
 * @Author lss
 * @Date 2020/12/25
 * @Version V1.0
 **/
@Data
@ApiModel(value = "用于传输数据.需要其他bto继承此类")
public class BaseDTO {
    @ApiModelProperty(value="当前页",example = "1")
    private Integer page;
    @ApiModelProperty(value="每页显示条数",example = "5")
    private Integer rows;
    @ApiModelProperty(value="排序字段")
    private String sort;
    @ApiModelProperty(value="是否升序")
    private String order;
    public String  getOrderBy(){
        return sort+" "+(Boolean.valueOf(order)?"desc":"asc");//将排序转为boolean类型   true为倒序 false为正序
    }
}

```

在mingrui-shop-server-api的pom.xml添加分页工具依赖

```xml
<!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
```

在shop包下新建dto包新建BrandDTO类 用来继承baseDTO

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.group.MingruiOperation;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import sun.plugin2.message.Message;

import javax.validation.constraints.NotNull;

/**
 * @ClassName BrandDTO
 * @Description: TODO
 * @Author lss
 * @Date 2020/12/25
 * @Version V1.0
 **/
@Data
@ApiModel(value="品牌DTO")
public class BrandDTO extends BaseDTO {
    @ApiModelProperty(value="品牌主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;
    @ApiModelProperty(value = "品牌名字")
    @NotNull(message = "品牌名字不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;
    @ApiModelProperty(value="品牌图片")
    private String image;
    @ApiModelProperty(value="品牌首字母")
    private Character letter;
}

```

在shop-entity包下新建实体类 BrandEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName BrandEntity
 * @Description: TODO
 * @Author lss
 * @Date 2020/12/25
 * @Version V1.0
 **/
@Data
@Table(name = "tb_brand")
public class BrandEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    private String name;

    private String image;

    private Character letter;
}

```

在shop-service接口中新建接口BrandService

```java
package com.baidu.shop.service;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

@Api(tags="品牌接口 ")
public interface BrandService {
    @GetMapping(value="brand/list")
    @ApiOperation(value = "查询品牌列表")
    Result<PageInfo<BrandEntity>>getBrandInfo(BrandDTO brandDTO);

}

```

在mingrui-shop-server-xxx下的shop-mapper添加BrandMapper接口

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.BrandEntity;
import tk.mybatis.mapper.common.Mapper;

public interface BrandMapper extends Mapper<BrandEntity> {
}

```

在shop-service.impl包下新建实现类BrandServiceImpl

```java
package com.baidu.shop.service.impl;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.entity.CategoryBrandEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.mapper.CategoryBrandMapper;
import com.baidu.shop.service.BrandService;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.ObjectUtil;
import com.baidu.shop.utils.PinyinUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

/**
 * @ClassName BrandServiceImpl
 * @Description: TODO
 * @Author lss
 * @Date 2020/12/25
 * @Version V1.0
 **/
@RestController
public class BrandServiceImpl extends BaseApiService implements BrandService {

    @Autowired
    private BrandMapper brandMapper;

    @Override
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO) {
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());//分页
		//排序字不为空的时候进行排序
        if(!StringUtils.isEmpty(brandDTO.getSort())) PageHelper.orderBy(brandDTO.getOrderBy());

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO,BrandEntity.class);

        Example example = new Example(BrandEntity.class);
        //品牌名字不为空的时候进行条件查询  
        if (ObjectUtil.isNotNull(brandEntity.getName())){
            //模糊匹配
            example.createCriteria().andLike("name","%"+brandEntity.getName()+"%");
        }

		//查询结果返回到一个List集合中
        List<BrandEntity>brandEntities=brandMapper.selectByExample(example);

        PageInfo<BrandEntity>pageInfo = new PageInfo<>(brandEntities);

        return this.setResultSuccess(pageInfo);
    }
}

```





### 新增

#### 前台

新建MrBrandForm.vue

```vue
<template>
  <div>
    <v-card-text>
      <v-form v-model="valid" ref="form">
        <v-text-field
          v-model="brand.name"
          label="品牌名称"
          :rules="nameRules"
          required
        ></v-text-field>
		//查询分类信息
        <v-cascader
          url="/category/list"
          required
          v-model="brand.categories"
          multiple
          label="商品分类"
        />

        <v-layout row>
          <v-flex xs3>
            <span style="font-size: 16px; color: #444">品牌LOGO：</span>
          </v-flex>
          <v-flex>
            <v-upload
              v-model="brand.image"
              url="/upload"
              :multiple="false"
              :pic-width="250"
              :pic-height="90"
            />
          </v-flex>
        </v-layout>
      </v-form>
    </v-card-text>

    <v-divider></v-divider>

    <v-card-actions>
      <v-spacer></v-spacer>
      <v-btn small @click="cancel()">取消</v-btn>
      <v-btn small color="primary" @click="submitForm()">确认</v-btn>
    </v-card-actions>
  </div>
</template>
<script>
export default {
  name: "MrBrandForm",
  props: {
    dialog: Boolean,//模态框状态设置为boolean类型
  },
  watch: {
    dialog(val) {
      if (val) this.$refs.form.reset();
    },
  },
  data() {
    //在js中 null == false , '' == false , undefined == false , 0 == false
    return {
      valid: true,
      nameRules: [
        (v) => !!v || "品牌名称不能为空",
        (v) => (v && v.length <= 10) || "品牌名称最多10个长度",
      ],
      brand: {
        name: "",
        image:'',
        categories: [],
      },
    };
  },
  methods: {
    cancel() {
      this.$emit("closeDialog");
    },
    submitForm() {
      if (!this.$refs.form.validate()) {
        return;
      }
      let formData = this.brand;
      let categoryIdArr = this.brand.categories.map((category) => category.id);
      formData.categories = categoryIdArr.join();

      this.$http
        .post("/brand/save", formData)
        .then((resp) => {
          if (resp.data.code != 200) {
            return;
          }
          //关闭模态框
          this.cancel();
          //刷新表单
        })
        .catch((error) => console.log(error));
    },
  },
};
</script>
```

在MrBrand中添加新增属性

```vue
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="dialog = true">新增</v-btn>//点击新增按钮打开模态框

      <div class="text-xs-center">
    <v-dialog
      v-model="dialog"
      width="500"
    >
      <v-card>
        <v-card-title
          class="headline grey lighten-2"
          primary-title
        >
          品牌新增
        </v-card-title>

        <mr-brand-form @closeDialog="dialog = false" :dialog="dialog"/>

      </v-card>
    </v-dialog>
  </div>

      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />

      <!--
            append-icon : 图标
            label : input默认值
        -->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <!-- 表格组件 -->
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center">
          <!-- src 是html标签的属性 :src="vue的属性" -->
          <img :src="props.item.image" />
        </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from './MrBrandForm';
export default {
  name: "MrBrand",
  components:{
    MrBrandForm
  },
  data() {
    return {
      pagination: {},
      dialog: false,
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    getTableData() {

      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    }
  },
  watch: {
    pagination() {
      this.getTableData();
    }
  }
};
</script>
```

#### 后台

在common-core中的utils包下新建工具类BaiduBeanUtil

```java
import org.springframework.beans.BeanUtils;

public class BaiduBeanUtil<T> {
    public static <T>T copyProperties(Object source,Class<T>clazz){
        try {
            T t= clazz.newInstance();
            BeanUtils.copyProperties(source,t);
            return t;
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
    return null;
    }
}

```

在BrandDTO中添加属性

```java
@NotNull(message = "品牌分类不能为空",groups = {MingruiOperation.Add.class})
    @ApiModelProperty(value="品牌分类信息")
    private String categories;
```

在entity下新建中间表的实体类CategoryBrandEntity	

```java
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import javax.persistence.Table;

@Table(name="tb_category_brand")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {

    private Integer categoryId;

    private Integer brandId;
}

```

在BrandService接口中添加新增方法

```java
@PostMapping(value="brand/save")
    @ApiOperation(value="新增品牌")
    Result<JSONObject>saveBrand(@RequestBody BrandDTO brandDTO);
```

在 mingrui-shop-service-xxx下的mapper中新建中间表的mapper  CategoryBrandMapper

```java
import com.baidu.shop.entity.CategoryBrandEntity;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

public interface CategoryBrandMapper extends InsertListMapper<CategoryBrandEntity>, Mapper<CategoryBrandEntity> {
}

```

##### 品牌首字母自动识别问题

在common-core中的pom.xml文件添加依赖

```xml
<dependency> 
	<groupId>com.belerweb</groupId> 
		<artifactId>pinyin4j</artifactId>
	<version>2.5.1</version> 
</dependency>
```

在utils包下新建PinYinUtil工具类

```java
import net.sourceforge.pinyin4j.PinyinHelper;
import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;
import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class PinyinUtil {

    public static final Boolean TO_FUUL_PINYIN = true;

    public static final Boolean TO_FIRST_CHAR_PINYIN = false;
    /**
     * 获取汉字首字母或全拼大写字母
     *
     * @param chinese 汉字
     * @param isFull  是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母大写字符窜
     */
    public static String getUpperCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toUpperCase();
    }

    /**
     * 获取汉字首字母或全拼小写字母
     *
     * @param chinese 汉字
     * @param isFull  是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母小写字符窜
     */
    public static String getLowerCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toLowerCase();
    }

    /**
     * 将汉字转成拼音
     * <p>
     * 取首字母或全拼
     *
     * @param hanzi  汉字字符串
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 拼音
     */
    private static String convertHanzi2Pinyin(String hanzi, boolean isFull) {
        /***
         * ^[\u2E80-\u9FFF]+$ 匹配所有东亚区的语言
         * ^[\u4E00-\u9FFF]+$ 匹配简体和繁体
         * ^[\u4E00-\u9FA5]+$ 匹配简体
         */
        String regExp = "^[\u4E00-\u9FFF]+$";
        StringBuffer sb = new StringBuffer();
        if (hanzi == null || "".equals(hanzi.trim())) {
            return "";
        }
        String pinyin = "";
        for (int i = 0; i < hanzi.length(); i++) {
            char unit = hanzi.charAt(i);
            //是汉字，则转拼音
            if (match(String.valueOf(unit), regExp)) {
                pinyin = convertSingleHanzi2Pinyin(unit);
                if (isFull) {
                    sb.append(pinyin);
                } else {
                    sb.append(pinyin.charAt(0));
                }
            } else {
                sb.append(unit);
            }
        }
        return sb.toString();
    }

    /**
     * 将单个汉字转成拼音
     *
     * @param hanzi 汉字字符
     * @return 拼音
     */
    private static String convertSingleHanzi2Pinyin(char hanzi) {
        HanyuPinyinOutputFormat outputFormat = new HanyuPinyinOutputFormat();
        outputFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);
        String[] res;
        StringBuffer sb = new StringBuffer();
        try {
            res = PinyinHelper.toHanyuPinyinStringArray(hanzi, outputFormat);
            sb.append(res[0]);//对于多音字，只用第一个拼音
        } catch (Exception e) {
            e.printStackTrace();
            return "";
        }
        return sb.toString();
    }

    /***
     * 匹配
     * <P>
     * 根据字符和正则表达式进行匹配
     *
     * @param str 源字符串
     * @param regex 正则表达式
     *
     * @return true：匹配成功  false：匹配失败
     */
    private static boolean match(String str, String regex) {
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(str);
        return matcher.find();
    }

}

```



在BrandServiceImpl中重新新增方法

```java
@Transactional
    @Override
    public Result<JSONObject> saveBrand(BrandDTO brandDTO) {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
        brandMapper.insertSelective(brandEntity);
		//调用封装方法
       this.saveOrUpdate(brandDTO.getCategories(),brandEntity.getId());
        return this.setResultSuccess();
    }
//封装  批量新增 新增  方法
     private void saveOrUpdate(String categories,Integer brandId){
        if(StringUtils.isEmpty(categories)) throw new RuntimeException("分类信息不能为空");

        //判断分类集合字符串中是否包含,
        if(categories.contains(",")){//多个分类 --> 批量新增

            categoryBrandMapper.insertList(
                    Arrays.asList(categories.split(","))
                            .stream()
                            .map(categoryIdStr -> new CategoryBrandEntity(Integer.valueOf(categoryIdStr)
                                    ,brandId))
                            .collect(Collectors.toList())
            );
            //其他写法
            // if(categories.contains(",")){
//            String[] categoryArr  = categories.split(",");
//
//            /*for (String s : categoryArr){
//                CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
//                categoryBrandEntity.setBrandId(brandEntity.getId());
//                categoryBrandEntity.setCategoryId(Integer.valueOf(s));
//                categoryBrandEntities.add(categoryBrandEntity);
//            }
//                categoryBrandMapper.insertList(categoryBrandEntities);*/
//            categoryBrandMapper.insertList(Arrays.asList(categoryArr).stream().map(categoryIdStr -> {
//                CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
//                categoryBrandEntity.setBrandId(brandEntity.getId());
//                categoryBrandEntity.setCategoryId(Integer.valueOf(categoryIdStr));
//                return categoryBrandEntity;
//            }).collect(Collectors.toList()));

        }else{//普通单个新增

            CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
            categoryBrandEntity.setBrandId(brandId);
            categoryBrandEntity.setCategoryId(Integer.valueOf(categories));

            categoryBrandMapper.insertSelective(categoryBrandEntity);
        }
```

##### 图片上传

在mingrui-shop-basics下新建mingrui-shop-basic-upload-server并在pom.xml文件中添加依赖

```xml
<dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-common-core</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
```

新建com.baidu.shop.upload.controller包

在包下新建类UploadController

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;
import java.io.File;
import java.io.IOException;
import java.util.UUID;

@RestController
@RequestMapping(value="upload")
public class UploadController extends BaseApiService {

        //linux系统的上传目录
        @Value(value = "${mingrui.upload.path.windows}")
        private String windowsPath;

        //window系统的上传目录
        @Value(value = "${mingrui.upload.path.linux}")
        private String linuxPath;

        @Value(value = "${mingrui.upload.img.host}")
        private String imageHost;

        @PostMapping
        public Result<String> uploadImg(@RequestParam MultipartFile file) {

            if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的文件是否为空

            String filename = file.getOriginalFilename();//获取文件名

            //String path = "";
            String os = System.getProperty("os.name").toLowerCase();
            String path = os.indexOf("win") != -1 ? windowsPath : os.indexOf("lin") != -1 ? linuxPath : "";
//        if(os.indexOf("win") != -1){
//            path = windowsPath;
//        }else if(os.indexOf("lin") != -1){
//            path = linuxPath;
//        }

            //UUID.randomUUID() + 1.jpg UUID.randomUUID() + 1.jpg
            filename = UUID.randomUUID() + filename;//防止文件名重复

            //创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
            File dest = new File(path + File.separator + filename);

            //判断文件夹是否存在,不存在的话就创建
            if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();

            try {
                file.transferTo(dest);//上传
            } catch (IllegalStateException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            } catch (IOException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }

            return this.setResult(HTTPStatus.OK,"upload success!!!",imageHost + "/" + filename);//将文件名返回页面用于页面回显
        }

    }

```

新建包结构com.baidu.gload

在包下新建类 GlobalCorsConfig

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new
                UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
//3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}

```









### 修改

#### 前台

Mrbrand.vue

```vue
<template>
  <v-card>
    <v-card-title>
      <v-btn color="info" @click="addData()">新增</v-btn>

      <div class="text-xs-center">
        <v-dialog v-model="dialog" width="500">
          <v-card>
            <v-card-title class="headline grey lighten-2" primary-title>
              品牌{{ isEdit?'修改':'新增' }}//判断isEntity是否为true 为true执行修改 反之新增
            </v-card-title>
            <!--将模态框的状态传递到子组件
            @closeModel="closeModel" 关闭模态框的函数中需要重置this.brandDetail,所以
            需要新建closeModel方法
            :isEdit="isEdit" 将新增还是修改的状态传递给子级组件
            :brandDetail="brandDetail" 修改回显的数据
            -->
            <mr-brand-form @closeDialog="closeDialog" :dialog="dialog" :isEdit="isEdit" :brandDetail="brandDetail" />
          </v-card>
        </v-dialog>
      </div>

      <!-- 调按钮和输入框之间的间距 -->
      <v-spacer />

      <!--
            append-icon : 图标
            label : input默认值
        -->
      <v-text-field
        append-icon="search"
        label="品牌名称"
        @keyup.enter="getTableData()"
        v-model="search"
      ></v-text-field>
    </v-card-title>
    <!-- 表格组件 -->
    <v-data-table
      :headers="headers"
      :items="desserts"
      :pagination.sync="pagination"
      :total-items="total"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center">
          <!-- src 是html标签的属性 :src="vue的属性" -->
          <img width="100" :src="props.item.image" />
        </td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="text-xs-center">
          <v-btn flat icon color="yellow" @click="editData(props.item)">
            <v-icon>edit</v-icon>
          </v-btn>
        </td>
      </template>
    </v-data-table>
  </v-card>
</template>
<script>
import MrBrandForm from "./MrBrandForm";
export default {
  name: "MrBrand",
  components: {
    MrBrandForm,
  },
  data() {
    return {
      brandDetail:{},
      isEdit:false,
      pagination: {},
      dialog: false,
      total: 0,
      search: "",
      headers: [
        {
          text: "id",
          align: "center",
          value: "id",
        },
        {
          text: "品牌名称",
          align: "center",
          value: "name",
        },
        {
          text: "品牌logo",
          align: "center",
          value: "image",
        },
        {
          text: "首字母",
          align: "center",
          value: "letter",
        },
        {
          text: "操作",
          align: "center",
          sortable: false,
          value: "id",
        },
      ],
      desserts: [],
    };
  },
  mounted() {
    this.getTableData();
  },
  methods: {
    closeDialog () {
      this.dialog = false;
      this.getTableData();
    },
    addData () {
      //this.brandDetail = {};
      this.isEdit = false;
      this.dialog = true;
    },
    editData (obj) {
      this.brandDetail = obj;
      this.isEdit = true;
      this.dialog = true;
    },
    getTableData() {
      this.$http
        .get("/brand/list", {
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            name: this.search,
          },
        })
        .then((resp) => {
          this.desserts = resp.data.data.list;
          this.total = resp.data.data.total;
        })
        .catch((error) => console.log(error));
    },
  },
  watch: {
    pagination() {
      this.getTableData();
    },
  },
};
</script>
```





#### 后台

修改需要先通过品牌的id 查询该品牌 绑定的 分类属性

在分类的CategroyService接口中

添加查询方法

```java
@ApiOperation(value = "通过品牌id查询商品分类")
    @GetMapping(value = "category/brand")
    Result<List<CategoryEntity>> getByBrand(Integer brandId);
```

在CategoryServiceImpl中重写接口中的查询方法

```java
 @Override
    public Result<List<CategoryEntity>> getByBrand(Integer brandId) {
        List<CategoryEntity> categoryByBrandId = categoryMapper.getCategoryByBrandId(brandId);
        return this.setResultSuccess(categoryByBrandId);
    }
```

在BrandService接口中添加修改方法

```java
@PutMapping(value="brand/save")
    @ApiOperation(value="修改品牌")
    Result<JSONObject>editBrand(@RequestBody BrandDTO brandDTO);
```

在BrandServiceImpl实现类中重写修改方法

```java
//修改
    @Transactional
    @Override
    public Result<JSONObject> editBrand(BrandDTO brandDTO) {
        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
        brandMapper.updateByPrimaryKeySelective(brandEntity);
        //通过brandId删除中间表
        this.deleteCategoryBrandByBrandId(brandDTO.getId());
        //批量新增  新增
        this.saveOrUpdate(brandDTO.getCategories(),brandEntity.getId());
        return this.setResultSuccess();
    }
```







### 删除

#### 前台

在Mrbrand中给删除按钮绑定删除事件

```vue
<v-btn flat icon @click="deleteData(props.item.id)" color="blue">
<v-icon>delete</v-icon>
</v-btn>
```

删除的方法

```js
 deleteData(id){
      this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
          // 发起删除请求
          this.$http.delete("/brand/delete?id=" + id,)
            .then(resp => {
              if(resp.data.code!=200){
                this.$message.error(resp.data.msg)
                return;
              }
              // 删除成功，重新加载数据
              this.$message.success("删除成功！");
              this.getTableData();
            }).catch(error => this.$message.error(error));
        }).catch(() => {
          this.$message.info("删除已取消！");
        });
```





#### 后台

mingrui-shop-server-api-xxx 中的 Brandservice接口写删除方法

```java
@DeleteMapping(value="brand/delete")
@ApiOperation(value="删除品牌")
Result<JSONObject>deleteBrand(Integer id);
```

mingrui-shop-service-xxx 中的BrandserviceImpl实现类重写接口中的删除方法

```java
@Transactional
@Override
public Result<JSONObject> deleteBrand(Integer id) {
    //通过id删除数据
    brandMapper.deleteByPrimaryKey(id);
    //通过brandId删除中间表
    this.deleteCategoryBrandByBrandId(id);	
    return this.setResultSuccess();
};
//封装通过brandId删除中间表的方法
 private void deleteCategoryBrandByBrandId(Integer brandId){
        Example example = new Example(CategoryBrandEntity.class);
        example.createCriteria().andEqualTo("brandId",brandId);
        categoryBrandMapper.deleteByExample(example);
 }

```





## 规格管理

### 查询

#### 前台

修改index.js页面29行

```
route("/item/specification",'/item/specification/Specification',"Specification"),
```

修改 specification下的Specification.vue  

把url换成自己的

```
<v-tree url="/category/list" :isEdit="false" @handleClick="handleClick"/>
```

修改SpecGroup.vue查询方法

把请求路径改成自己的

```
loadData(){
          this.$http.get("/specgroup/getSpecGroupInfo",{
              params:{
                  cid:this.cid
              }
          })
          .then(({data}) => {
              this.groups = data.data;
          })
          .catch(() => {
              this.groups = [];
          })
      },
```



#### 后台

在mingrui-shop-service-api-xxxx下的entity包下新建SpecGroupEntity

```java
import lombok.Data;
import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_group")
@Data
public class SpecGroupEntity {
    @Id
    private Integer id;

    private Integer cid;

    private String name;
}

```

dto包下新建SpecGroupDTO

```java
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "规格组数据输出DTO")
@Data
public class SpecGroupDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类Id",example = "1")
    @NotNull(message = "分类Id不能为空",groups = {MingruiOperation.Update.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组名称")
    @NotEmpty(message = "规格名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;
}

```

在service包下新建SpecificationService

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@Api("规格接口")
public interface SpecificationService {
    @ApiOperation("通过条件查询规则数据")
    @GetMapping("specgroup/getSpecGroupInfo")
    Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDTO specGroupDTO);
 }
```

在 mingrui-shop-service-xxx下的mapper包下新建SpecGroupMapper

```java
import com.baidu.shop.entity.SpecGroupEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecGroupMapper extends Mapper<SpecGroupEntity> {
}
```

在service.impl下新建SpecificationServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SpecGroupDTO;
import com.baidu.shop.entity.SpecGroupEntity;
import com.baidu.shop.mapper.SpecGroupMapper;
import com.baidu.shop.service.SpecificationService;
import com.baidu.shop.utils.ObjectUtil;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;
import javax.annotation.Resource;
import java.util.List;

@RestController
public class SpecificationServiceImpl extends BaseApiService implements SpecificationService {
    @Resource
    private SpecGroupMapper specGroupMapper;

    @Override
    public Result<List<SpecGroupEntity>> getSpecGroupInfo(SpecGroupDTO specGroupDTO) {

        Example example = new Example(SpecGroupEntity.class);
        if(ObjectUtil.isNotNull(specGroupDTO.getCid())){ example.createCriteria().andEqualTo("cid",BaiduBeanUtils.copyProperties(specGroupDTO,SpecGroupEntity.class).getCid());
}
        List<SpecGroupEntity> specGroupEntities = specGroupMapper.selectByExample(example);
        return this.setResultSuccess(specGroupEntities);
    }
}

```



### 增删改

#### 前台

SpecGroup.vue

```vue
save() {
      this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/specgroup/saveSpecGroup",
        data: this.group,
      })
        .then(() => {
          // 关闭窗口
          this.show = false;
          this.$message.success("保存成功！");
          this.loadData();
        })
        .catch(() => {
          this.$message.error("保存失败！");
        });
    },
    deleteGroup(id) {
      this.$message.confirm("确认要删除分组吗？").then(() => {
        this.$http.delete("/specgroup/deleteSpecGroup?id=" + id).then((resp) => {
          if (resp.data.code != 200) {
            this.$message.error("当前规格组下有规格参数 ，请先删除规格参数")
            return;
          }
          this.$message.success("删除成功");
          this.loadData();
        });
      });
    },
```



#### 后台

SpecificationService

新增方法

```java
@ApiOperation(value = "新增规格组")
    @PostMapping(value = "specgroup/saveSpecGroup")
    Result<JSONObject> saveSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "修改规格组")
    @PutMapping(value = "specgroup/saveSpecGroup")
    Result<JSONObject> editSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    @ApiOperation(value = "删除规格组")
    @DeleteMapping(value = "specgroup/deleteSpecGroup")
    Result<JSONObject> deleteSpecGroup(Integer id);
```



SpecificationServiceImpl接口实现类实现方法	

```java
 @Transactional
    @Override
    public Result<JSONObject> saveSpecGroup(SpecGroupDTO specGroupDTO) {
        specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> editSpecGroup(SpecGroupDTO specGroupDTO) {
        specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> deleteSpecGroup(Integer id) {

        //判断规格组下是否有规格参数
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId" , id);
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);

        if(specParamEntities.size() >= 1 ) return this.setResultError("当前规格组下有规格参数 ，请先删除规格参数");

        specGroupMapper.deleteByPrimaryKey(id);

        return this.setResultSuccess();
    }

```



### 规格参数

#### 查询

##### 前台

修改SpecParam.vue的125行

```java
loadData() {
      this.$http
        .get("/specparam/getSpecParamInfo",{
          params:{
            groupId:this.group.id
          }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    }
```



##### 后台

mingrui-shop-service-api-xxxx的entity包下新建

SpecParamEntity

```java
import lombok.Data;
import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_param")
@Data
public class SpecParamEntity {

    @Id
    private Integer id;

    private Integer cid;

    private Integer groupId;

    private String name;

    @Column(name = "`numeric`")
    private Boolean numeric;

    private String unit;

    private Boolean generic;

    private Boolean searching;

    private String segments;

}


```



dto包下新建SpecParamDTO

SpecParamDTO

```java
import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "规格参数数据传输DTO")
@Data
public class SpecParamDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空" , groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id" , example = "1")
    private Integer cid;

    @ApiModelProperty(value = "规格组id", example = "1")
    private Integer groupId;

    @ApiModelProperty(value = "规格参数名称")
    @NotEmpty(message = "规格参数名称不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String name;

    @ApiModelProperty(value = "是否是数字类型参数，true或false" , example = "0")
    @NotNull(message = "是否是数字类型参数不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Boolean numeric;

    @ApiModelProperty(value = "数字类型参数的单位，非数字类型可以为空")
    private String unit;

    @ApiModelProperty(value = "是否是sku通用属性，true或false" , example = "0")
    @NotNull(message = "是否是sku通用属性不能为空" , groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private Boolean generic;

    @ApiModelProperty(value = "是否用于搜索过滤，true或false" , example = "0")
    @NotNull(message = "是否用于搜索过滤不能为空" , groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean searching;

    @ApiModelProperty(value = "数值类型参数，如果需要搜索，则添加分段间隔值，如CPU频率间隔：0.5-1.0")
    private String segments;

}

```



SpecificationService中添加

```java
@ApiOperation(value = "查询规格参数")
    @GetMapping(value = "specparam/getSpecParamInfo")
    Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO);
```



mingrui-shop-service-xxx  mapper包下   新建SpecParamMapper

SpecParamMapper

```java
import com.baidu.shop.entity.SpecParamEntity;
import tk.mybatis.mapper.common.Mapper;

public interface SpecParamMapper extends Mapper<SpecParamEntity> {
}

```



SpecificationServiceImpl实现类实现查询方法

```java
@Autowired
private SpecParamMapper specParamMapper;
   
   
 @Override
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {

        SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);

        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamEntity.getGroupId());

        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);

        return this.setResultSuccess(specParamEntities);
    }
```



#### 增删改

##### 前台

SpecParam.vue

```vue
deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("/specparam/delete?id="+ id)
            .then(() => {
                this.$message.success("删除成功");
                this.loadData();
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    },
save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: 'specparam/save',
            data: p,
        }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
    

```



##### 后台

SpecificationService接口添加增删改方法

```java
@ApiOperation(value = "新增规格参数")
    @PostMapping(value = "specparam/save")
    Result<JSONObject> saveSpecParam(@RequestBody SpecParamDTO specParamDTO);

    @ApiOperation(value = "新增规格参数")
    @PutMapping(value = "specparam/save")
    Result<JSONObject> editSpecParam(@RequestBody SpecParamDTO specParamDTO);

    @ApiOperation(value = "删除规格参数")
    @DeleteMapping(value = "specparam/delete")
    Result<JSONObject> deleteSpecParam(Integer id);
```



SpecificationServiceImpl实现类实现增删改方法

```java
@Transactional
    @Override
    public Result<JSONObject> saveSpecParam(SpecParamDTO specParamDTO) {

        specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));

        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> editSpecParam(SpecParamDTO specParamDTO) {

        specParamMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));

        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> deleteSpecParam(Integer id) {

        specParamMapper.deleteByPrimaryKey(id);

        return this.setResultSuccess();
    }
```



##### 修改后无法新增规格参数

前台

SpecParam.vue   147行 addParam方法里添加 this.isEdit = false;  	

```
addParam() {
      this.param = {
          cid: this.group.cid,
          groupId: this.group.id,
          segments:[],
          numeric:false,
          searching:false,
          generic:false}
      this.show = true;
      this.isEdit = false;
    },
```







## 商品管理

 解压实训工具里 fastDFS压缩包.把压缩文件放桌面

linux系统中在自己的目录下

新建fastDFS目录

```
mkdir fastDFS
```

把刚解压的压缩包里的文件全部上传到这里面

### 安装C/C++ 编译环境

```
yum -y install gcc gcc-c++ autoconf pcre pcre-devel make automake  / 如果出现以下就是安装成功
```

### 安装libevent

```


yum -y install libevent/ 如果出现以下就是安装成功
```

### 安装 libfastcommon

```
tar -xvf libfastcommon-master.tar #解压压缩包
cd libfastcommon-master/ #进入目录
./make.sh #编译




./make.sh install #安装
cp /usr/lib64/libfastcommon.so /usr/lib #复制镜像

```

### 安装FastDFS

```
cd .. #进入fastDFS目录
tar -zxvf FastDFS_v5.08.tar.gz #解压压缩包
cd FastDFS/ #进入目录
./make.sh #编译
./make.sh install #安装
```

### 启动tracker

```
cd /etc/fdfs #进入fastDFS配置目录
cp tracker.conf.sample tracker.conf #复制文件
vi tracker.conf #编辑刚刚复制的配置文件
```

修改配置

```
base_path=/shop/fdfs/tracker
```

保存退出

创建刚刚设置的目录

```
mkdir -p /shop/fdfs/tracker
```

启动tracker

```
service fdfs_trackerd start #停止换成stop
```

启动storage

```
cp storage.conf.sample storage.conf
vi storage.conf
```

修改配置

```
base_path=/shop/fdfs/storage
store_path0=/shop/fdfs/storage
tracker_server=本机ip地址:22122 #注意不能写localhost,需要写ip地址
```

保存并退出

创建刚刚设置的目录

```
mkdir -p /shop/fdfs/storage
```

启动storage	

```
service fdfs_storaged start
```

查看进程

```
ps -ef | grep fdfs
```

### 安装FastDFS的Nginx模块

进入压缩包所在的目录

```
tar -zxvf fastdfs-nginx-module_v1.16.tar.gz #解压压缩包
cd fastdfs-nginx-module/src/ #进入目录
vi config
//直接输入下面的命令,注意冒号需要手敲
: -->   %s+/usr/local/+/usr/+g --> enter --> esc --> :wq --> enter
```

保存并退出

```
cp mod_fastdfs.conf /etc/fdfs/ #复制文件
vi /etc/fdfs/mod_fastdfs.conf
```

修改默认配置

```
connect_timeout=10
tracker_server=本机ip地址:22122 #不能写localhost
url_have_group_name = true
store_path0=/shop/fdfs/storage
```

保存并退出

进入FastDFS/conf目录

```
cp http.conf mime.types /etc/fdfs/ #复制文件

```

###  安装Nginx

进入压缩包所在的目录

```
tar -zxvf nginx-1.10.0.tar.gz #解压压缩包
yum -y install make zlib-devel libtool openssl openssl-devel #安装依赖
cd nginx-1.10.0/
./configure --prefix=/opt/nginx --sbin-path=/usr/bin/nginx --add-module=/jlz/fastDFS/fastdfs-nginx-module/src

```

注意: --prefix= --> nginx配置文件所在目录 --sbin-path= --> 执行程序文件所在目录 --add-module= -->外部模块路径，启用对外部模块的支持 这个路径一定不能配置错,就写你自己 fastdfs-nginx-module的目录即可	

```
make && make install #编译并安装
```

编辑nginx的配置文件

```
vi /opt/nginx/conf/nginx.conf
```

server的配置

```
listen 80;
server_name localhost:8888;#storage的端口号
# 监听域名中带有group的，交给FastDFS模块处理
location ~/group([0-9])/ {
ngx_fastdfs_module;
}
```

保存并退出

```
cd /opt/nginx #nginx主目录

```

启动nginx

```
nginx
nginx -s stop #停止
nginx -s reload #重新加载配置
```

浏览器输入ip地址访问

至此,fastDFS安装成功,尽量不要重启云服务,因为没有设置开机启动.....想设置的话自行百度吧



### java上传文件到fastDFS服务

pom.xml

```java
<dependency>
	<groupId>com.github.tobato</groupId>
	<artifactId>fastdfs-client</artifactId>
	<version>1.26.1-RELEASE</version>
</dependency>
```

application.yml

```yml
server:
  port: 8200
spring:
  application:
    name: upload-server
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka

//以下为修改的内容
fdfs:
  so-timeout: 1501
  connect-timeout: 601
  thumb-image: # 缩略图
    width: 60
    height: 60
  tracker-list: # tracker地址
    - 82.156.80.49:22122

mingrui:
  upload:
    path:
      windows: D:\\images
      linux: /han/images
    img:
      host: http://82.156.80.49/
```



config包下新建配置类FastClientImporter

```java
import com.github.tobato.fastdfs.FdfsClientConfig;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.EnableMBeanExport;
import org.springframework.context.annotation.Import;
import org.springframework.jmx.support.RegistrationPolicy;

@Configuration
@Import(FdfsClientConfig.class)
@EnableMBeanExport(registration = RegistrationPolicy.IGNORE_EXISTING)
public class FastClientImporter {
}

```



上传文件controller

```java
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import com.github.tobato.fastdfs.domain.StorePath;
import com.github.tobato.fastdfs.domain.ThumbImageConfig;
import com.github.tobato.fastdfs.service.FastFileStorageClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;

@RestController
@RequestMapping(value = "upload")
@Slf4j
public class FastDFSUploadController {
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imgHost;

    // 负责存储图片的客户端
    @Autowired
    private FastFileStorageClient storageClient;

    //缩略图配置
    @Autowired
    private ThumbImageConfig thumbImageConfig;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) throws IOException {

        InputStream inputStream = file.getInputStream();//获取文件输入流(二进制字节流)
        String filename = file.getOriginalFilename();//文件名
        //1.aa.jpg substring 要头不要尾
        String ex = filename.substring(filename.lastIndexOf(".") + 1);//文件后缀名
        // 上传并且生成缩略图
        StorePath storePath = this.storageClient.uploadImageAndCrtThumbImage(
                inputStream, file.getSize(), ex, null);//上传
        // 带分组的路径
        log.info("上传图片全路径:{}", storePath.getFullPath());
        // 不带分组的路径
        log.info("上传图片路径:{}", storePath.getPath());
        // 获取缩略图路径
        String path = thumbImageConfig.getThumbImagePath(storePath.getFullPath());
        log.info("缩略图路径:{}", path);

        return new Result<String>(HTTPStatus.OK,"上传成功",imgHost + path);
    }
}

```

